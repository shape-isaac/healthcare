<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·é¥®é£Ÿè®°å½•ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* è¾“å…¥åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        .input-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            transition: transform 0.2s ease;
        }

        .input-section:hover {
            transform: translateY(-2px);
        }

        .input-section h2 {
            color: #1a1a1a;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-left: 4px solid #4CAF50;
            padding-left: 12px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .input-group select,
        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .input-group select:focus,
        .input-group input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
        }

        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76,175,80,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* å›¾è¡¨åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        .display-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        /* AI åˆ†ææŠ¥å‘Šæ ·å¼ä¼˜åŒ– */
        .analysis-report {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .report-section {
            margin-bottom: 25px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .report-section h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .data-item {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: 700;
            color: #4CAF50;
            margin-right: 15px;
        }

        .tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .tag:hover {
            background: #c8e6c9;
            transform: translateY(-2px);
        }

        /* åŠ è½½åŠ¨ç”»ä¼˜åŒ– */
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
            color: #666;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80% { content: "...."; }
            100% { content: "....."; }
        }

        /* çƒ­åŠ›å›¾æ ·å¼ */
        .heatmap-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .heatmap-title {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .meal-heatmap {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .meal-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #555;
        }

        .heat-bar {
            height: 40px;
            background: #e8f5e9;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .heat-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .calories-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #1b5e20;
            font-weight: 600;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        /* çƒ­åŠ›å›¾åŠ¨æ•ˆå’Œæç¤ºæ¡†æ ·å¼ */
        .heat-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: all 0.5s ease;
            border-radius: 6px;
            cursor: pointer;
        }

        .heat-fill:hover {
            filter: brightness(1.1);
            transform: scaleY(1.05);
            box-shadow: 0 0 10px rgba(76,175,80,0.3);
        }

        .meal-tooltip {
            position: absolute;  /* æ”¹å› absolute å®šä½ */
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 0.9em;
            z-index: 1000;
            max-width: 300px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .meal-tooltip.visible {
            opacity: 1;
        }

        .meal-tooltip-title {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .meal-tooltip-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .meal-tooltip-list li {
            padding: 3px 0;
            color: #555;
        }

        .meal-tooltip-list li:before {
            content: "â€¢";
            color: #4CAF50;
            margin-right: 5px;
        }

        .input-hint {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        /* ä¿®æ”¹å¡è·¯é‡Œè¾“å…¥æ¡†æ ·å¼ */
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        input[type="number"]:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
        }

        .amount-hints {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .hint-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .hint-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .hint-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .hint-text {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* æ·»åŠ é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-message {
            background: #fff3f3;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .error-message h3 {
            color: #dc3545;
            margin-bottom: 10px;
        }

        .error-message ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .error-message li {
            color: #666;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ•°æ®å½•å…¥åŒºåŸŸ -->
        <div class="input-section">
            <h2>è®°å½•é¥®é£Ÿ</h2>
            <div class="input-group">
                <label for="date">æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>
            <div class="input-group">
                <label for="time">æ—¶é—´</label>
                <input type="time" id="time" onchange="updateMealType()">
            </div>
            <div class="input-group">
                <label for="mealType">ç”¨é¤ç±»å‹</label>
                <select id="mealType">
                    <option value="breakfast">æ—©é¤</option>
                    <option value="lunch">åˆé¤</option>
                    <option value="dinner">æ™šé¤</option>
                    <option value="snack">åŠ é¤</option>
                </select>
            </div>
            <div class="input-group">
                <label for="food">é£Ÿç‰©åç§°</label>
                <input type="text" id="food" placeholder="è¯·è¾“å…¥é£Ÿç‰©åç§°">
            </div>
            <div class="input-group">
                <label for="amount">ä»½é‡</label>
                <input type="text" id="amount" placeholder="å¦‚ï¼šä¸€ç¢—ã€ä¸¤ç‰‡ã€300g">
                <div class="amount-hints">
                    <div class="hint-title">æ”¯æŒçš„é‡è¯ï¼š</div>
                    <div class="hint-tags">
                        <span class="hint-tag">ç¢—</span>
                        <span class="hint-tag">ä»½</span>
                        <span class="hint-tag">ç‰‡</span>
                        <span class="hint-tag">ä¸ª</span>
                        <span class="hint-tag">ç›’</span>
                        <span class="hint-tag">æ¯</span>
                        <span class="hint-tag">g/å…‹</span>
                    </div>
                    <div class="hint-text">
                        â€¢ æ”¯æŒä¸­æ–‡æ•°å­—ï¼ˆä¸€ã€äºŒã€ä¸¤ã€ä¸‰...ï¼‰<br>
                        â€¢ "é€‚é‡"/"å°‘è®¸" æŒ‰ 50g è®¡ç®—<br>
                        â€¢ æ— å•ä½é»˜è®¤ä¸ºå…‹(g)
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label for="category">é£Ÿç‰©ç±»åˆ«</label>
                <select id="category">
                    <option value="ä¸»é£Ÿ">ä¸»é£Ÿ(ç±³é¥­/é¢åŒ…/é¢æ¡/é¦’å¤´ç­‰)</option>
                    <option value="è‚‰ç±»">è‚‰ç±»(çŒªè‚‰/ç‰›è‚‰/ç¾Šè‚‰ç­‰)</option>
                    <option value="ç¦½ç±»">ç¦½ç±»(é¸¡è‚‰/é¸­è‚‰/é¹…è‚‰ç­‰)</option>
                    <option value="æ°´äº§">æ°´äº§(é±¼/è™¾/èŸ¹ç­‰)</option>
                    <option value="è›‹ç±»">è›‹ç±»(é¸¡è›‹/é¸­è›‹/çš®è›‹ç­‰)</option>
                    <option value="è±†åˆ¶å“">è±†åˆ¶å“(è±†è…/è±†æµ†/è…ç«¹ç­‰)</option>
                    <option value="å¶èœç±»">å¶èœç±»(ç”Ÿèœ/è èœ/ç™½èœç­‰)</option>
                    <option value="æ ¹èŒç±»">æ ¹èŒç±»(èƒ¡èåœ/åœŸè±†/å±±è¯ç­‰)</option>
                    <option value="èŒè‡ç±»">èŒè‡ç±»(é¦™è‡/å¹³è‡/æœ¨è€³ç­‰)</option>
                    <option value="æ°´æœ">æ°´æœ(è‹¹æœ/é¦™è•‰/æ©™å­ç­‰)</option>
                    <option value="åšæœ">åšæœ(èŠ±ç”Ÿ/æ ¸æ¡ƒ/æä»ç­‰)</option>
                    <option value="ä¹³åˆ¶å“">ä¹³åˆ¶å“(ç‰›å¥¶/é…¸å¥¶/å¥¶é…ªç­‰)</option>
                    <option value="é›¶é£Ÿ">é›¶é£Ÿ(é¥¼å¹²/ç³–æœ/è–¯ç‰‡ç­‰)</option>
                    <option value="é¥®å“">é¥®å“(å’–å•¡/èŒ¶/æœæ±ç­‰)</option>
                    <option value="è°ƒå‘³å“">è°ƒå‘³å“(é…±æ²¹/é†‹/æ²¹ç­‰)</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="input-group">
                <label for="calories">å¡è·¯é‡Œï¼ˆå¯é€‰ï¼‰</label>
                <input type="number" id="calories" placeholder="è¯·è¾“å…¥å¡è·¯é‡Œå€¼ï¼ˆå¯é€‰ï¼‰" min="0" step="0.1">
                <div class="input-hint">è‹¥ä¸å¡«å†™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å¡è·¯é‡Œå€¼</div>
            </div>
            <button class="btn" onclick="addFoodRecord()">æ·»åŠ è®°å½•</button>
        </div>

        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
        <div class="display-section">
            <div class="chart-container" id="caloriesChart"></div>
            <div class="heatmap-container">
                <div class="heatmap-title">ä»Šæ—¥å¡è·¯é‡Œåˆ†å¸ƒ</div>
                <div id="mealHeatmap"></div>
            </div>
        </div>

        <!-- åœ¨ AIåˆ†æç»“æœåŒºåŸŸ ä¹‹å‰æ·»åŠ å¯¼å…¥å¯¼å‡ºæŒ‰é’® -->
        <div class="input-section">
            <h2>æ•°æ®ç®¡ç†</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="exportRecords()">å¯¼å‡ºæ•°æ®</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importRecords(event)">
                <button class="btn" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                <button class="btn" style="background-color: #dc3545;" onclick="clearAllRecords()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            </div>
        </div>

        <!-- AIåˆ†æç»“æœåŒºåŸŸ -->
        <div class="input-section">
            <h2>AI åˆ†ææŠ¥å‘Š</h2>
            <h3>å¥½æŠ¥å‘Šéœ€è¦é…é…¿ï¼Œè¯·ç»™æˆ‘ä»¬3åˆ†é’Ÿæ¸©æš–ç­‰å¾…â¤</h3>
            <div id="aiAnalysis"></div>
            <button class="btn" onclick="generateAIAnalysis()">ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
        </div>
    </div>

    <script>
        // 1. é¦–å…ˆå®šä¹‰å¸¸é‡é…ç½®å¯¹è±¡
        const CONFIG = {
            STANDARD_PORTIONS: {
                "ç¢—": 250,
                "ä»½": 200,
                "ç‰‡": 30,
                "ä¸ª": {
                    "æ°´æœ": 150,
                    "é¸¡è›‹": 50
                },
                "ç›’": 200,
                "æ¯": 250
            },
            CALORIES_DATABASE: {
                "ä¸»é£Ÿ": {
                    "ç±³é¥­": 116,
                    "é¢åŒ…": 260,
                    "é¢æ¡": 110,
                    "é¦’å¤´": 223,
                    "é¥ºå­": 200
                },
                "è‚‰ç±»": {
                    "çŒªè‚‰": 143,
                    "ç‰›è‚‰": 250,
                    "ç¾Šè‚‰": 203
                },
                "ç¦½ç±»": {
                    "é¸¡è‚‰": 165,
                    "é¸­è‚‰": 240,
                    "é¹…è‚‰": 238
                },
                "æ°´äº§": {
                    "é±¼": 100,
                    "è™¾": 85,
                    "èŸ¹": 97
                },
                "è›‹ç±»": {
                    "é¸¡è›‹": 155,
                    "é¸­è›‹": 185,
                    "çš®è›‹": 127
                },
                "è±†åˆ¶å“": {
                    "è±†è…": 76,
                    "è±†æµ†": 31,
                    "è…ç«¹": 225
                },
                "å¶èœç±»": {
                    "ç”Ÿèœ": 15,
                    "è èœ": 23,
                    "ç™½èœ": 20
                },
                "æ ¹èŒç±»": {
                    "èƒ¡èåœ": 41,
                    "åœŸè±†": 76,
                    "å±±è¯": 88
                },
                "èŒè‡ç±»": {
                    "é¦™è‡": 26,
                    "å¹³è‡": 29,
                    "æœ¨è€³": 31
                },
                "æ°´æœ": {
                    "è‹¹æœ": 52,
                    "é¦™è•‰": 93,
                    "æ©™å­": 47
                },
                "åšæœ": {
                    "èŠ±ç”Ÿ": 589,
                    "æ ¸æ¡ƒ": 654,
                    "æä»": 579
                },
                "ä¹³åˆ¶å“": {
                    "ç‰›å¥¶": 60,
                    "é…¸å¥¶": 70,
                    "å¥¶é…ª": 366
                },
                "é›¶é£Ÿ": {
                    "é¥¼å¹²": 435,
                    "è–¯ç‰‡": 542,
                    "å·§å…‹åŠ›": 545
                },
                "é¥®å“": {
                    "å’–å•¡": 1,
                    "èŒ¶": 1,
                    "æœæ±": 45
                }
            },
            API: {
                DEEPSEEK_API_TOKEN: 'your-default-token',
                DEEPSEEK_API_URL: 'https://api.deepseek.com/v1/chat/completions',  // ä¿®æ”¹ä¸ºæ­£ç¡®çš„APIåœ°å€
                // æ·»åŠ å¤‡ç”¨ API
                FALLBACK_API_URL: 'https://api-fallback.deepseek.com/v1/chat/completions'
            }
        };

        // 2. å…¨å±€å˜é‡
        let foodRecords = { records: [] };
        let chartInstance = null;

        // 3. è¾…åŠ©å‡½æ•°
        function chineseToNumber(chinese) {
            const numbers = {
                'é›¶': 0, 'ä¸€': 1, 'äºŒ': 2, 'ä¸¤': 2, 'ä¸‰': 3, 'å››': 4,
                'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åŠ': 0.5
            };
            return numbers[chinese] || chinese;
        }

        // 4. é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // åŠ è½½ä¿å­˜çš„æ•°æ®
                const savedData = localStorage.getItem('foodRecords');
                if (savedData) {
                    foodRecords = JSON.parse(savedData);
                    console.log('å·²åŠ è½½æœ¬åœ°æ•°æ®:', foodRecords);
                }

                // åˆå§‹åŒ–å›¾è¡¨
                initializeCharts();
                
                // è®¾ç½®å½“å‰æ—¥æœŸå’Œæ—¶é—´
                const now = new Date();
                document.getElementById('date').valueAsDate = now;
                document.getElementById('time').value = 
                    `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                // è®¾ç½®ç”¨é¤ç±»å‹
                updateMealType();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });

        // 3. ä¿®æ”¹åˆå§‹åŒ–å›¾è¡¨å‡½æ•°
        function initializeCharts() {
            try {
                const chartDom = document.getElementById('caloriesChart');
                if (!chartDom) {
                    throw new Error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');
                }

                // ç¡®ä¿å®¹å™¨å°ºå¯¸
                chartDom.style.width = '100%';
                chartDom.style.height = '350px';

                // é”€æ¯æ—§å®ä¾‹
                if (chartInstance) {
                    chartInstance.dispose();
                }

                // åˆ›å»ºæ–°å®ä¾‹
                chartInstance = echarts.init(chartDom);
                
                // è®¾ç½®åŸºç¡€é…ç½®
                const option = {
                    title: { text: 'å¡è·¯é‡Œæ‘„å…¥è¶‹åŠ¿', left: 'center' },
                    tooltip: { trigger: 'axis', formatter: '{b}: {c} å¡è·¯é‡Œ' },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: [],
                        axisLabel: { rotate: 45, interval: 0 }
                    },
                    yAxis: { type: 'value', name: 'å¡è·¯é‡Œ' },
                    series: [{
                        name: 'æ¯æ—¥å¡è·¯é‡Œ',
                        type: 'line',
                        data: [],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: { color: '#4CAF50' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(76,175,80,0.3)' },
                                { offset: 1, color: 'rgba(76,175,80,0.1)' }
                            ])
                        }
                    }]
                };
                
                chartInstance.setOption(option);
                
                // æ›´æ–°æ•°æ®
                updateChartData();
                
                // å“åº”å¼å¤„ç†
                window.addEventListener('resize', () => chartInstance.resize());
                
                console.log('å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // 4. æ·»åŠ æ›´æ–°å›¾è¡¨æ•°æ®çš„å‡½æ•°
        function updateChartData() {
            if (!chartInstance || !foodRecords.records) return;

            try {
                // æŒ‰æ—¥æœŸæ’åºå¹¶è®¡ç®—æ¯æ—¥å¡è·¯é‡Œ
                const chartData = foodRecords.records
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        date: record.date,
                        calories: record.meals.reduce((total, meal) => 
                            total + meal.foods.reduce((mealTotal, food) => 
                                mealTotal + (parseFloat(food.calories) || 0), 0), 0)
                    }));

                console.log('å›¾è¡¨æ•°æ®:', chartData);

                // æ›´æ–°å›¾è¡¨
                chartInstance.setOption({
                    xAxis: { data: chartData.map(d => d.date) },
                    series: [{ data: chartData.map(d => Math.round(d.calories)) }]
                });

                // æ›´æ–°çƒ­åŠ›å›¾
                updateHeatmap();
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // 5. ä¿®æ”¹å¯¼å…¥è®°å½•å‡½æ•°
        function importRecords(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('å¯¼å…¥çš„åŸå§‹æ•°æ®:', data);

                    // éªŒè¯æ•°æ®ç»“æ„
                    if (!data || !Array.isArray(data.records)) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼ï¼šç¼ºå°‘recordsæ•°ç»„');
                    }

                    // åˆå¹¶æˆ–æ›¿æ¢æ•°æ®
                    if (confirm('æ˜¯å¦è¦åˆå¹¶æ•°æ®ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"åˆå¹¶ï¼Œç‚¹å‡»"å–æ¶ˆ"æ›¿æ¢')) {
                        const existingDates = new Set(foodRecords.records.map(r => r.date));
                        foodRecords.records = [
                            ...foodRecords.records,
                            ...data.records.filter(r => !existingDates.has(r.date))
                        ];
                    } else {
                        foodRecords = { records: [...data.records] };
                    }

                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('foodRecords', JSON.stringify(foodRecords));

                    // æ›´æ–°å›¾è¡¨
                    updateChartData();

                    alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.records.length} æ¡è®°å½•`);
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                }
            };

            reader.onerror = () => alert('æ–‡ä»¶è¯»å–é”™è¯¯');
            reader.readAsText(file);
            event.target.value = '';
        }

        // å…¶ä½™å‡½æ•°ä¿æŒä¸å˜
        // 1. æ•°æ®åˆå§‹åŒ–å‡½æ•° - ç¡®ä¿åªåœ¨éœ€è¦æ—¶åˆå§‹åŒ–ä¸€æ¬¡
        function initializeFoodRecords() {
            try {
                const savedData = localStorage.getItem('foodRecords');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                    if (parsedData && Array.isArray(parsedData.records)) {
                        foodRecords = parsedData;
                    }
                }
                return true;
            } catch (error) {
                console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error);
                foodRecords = { records: [] };
                return false;
            }
        }

        // 2. ä¿®æ”¹é¡µé¢åŠ è½½å‡½æ•°
        window.onload = function() {
            // åˆå§‹åŒ–æ•°æ®
            initializeFoodRecords();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            updateCharts();
            
            // è®¾ç½®å½“å‰æ—¥æœŸå’Œæ—¶é—´
            const now = new Date();
            document.getElementById('date').valueAsDate = now;
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('time').value = `${hours}:${minutes}`;
            
            // è®¾ç½®ç”¨é¤ç±»å‹
            updateMealType();
        };

        // ä¿å­˜è®°å½•åˆ°æ–‡ä»¶
        async function saveFoodRecords() {
            try {
                localStorage.setItem('foodRecords', JSON.stringify(foodRecords));
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert('ä¿å­˜è®°å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´');
            }
        }

        // æ·»åŠ é£Ÿç‰©è®°å½•
        async function addFoodRecord() {
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const mealType = document.getElementById('mealType').value;
            const food = document.getElementById('food').value;
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;

            if (!food || !amount) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const record = {
                date,
                meals: [{
                    time,
                    type: mealType,
                    foods: [{
                        name: food,
                        amount,
                        category,
                        calories: calculateCalories(food, amount, category),
                        isManualCalories: !!document.getElementById('calories').value // æ·»åŠ æ ‡è®°æ˜¯å¦ä¸ºæ‰‹åŠ¨è¾“å…¥
                    }]
                }]
            };

            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥æ—¥æœŸçš„è®°å½•
            const existingRecordIndex = foodRecords.records.findIndex(r => r.date === date);
            if (existingRecordIndex >= 0) {
                foodRecords.records[existingRecordIndex].meals.push(record.meals[0]);
            } else {
                foodRecords.records.push(record);
            }

            // ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
            await saveFoodRecords();

            // æ¸…ç©ºè¾“å…¥
            document.getElementById('food').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('calories').value = '';

            // æ›´æ–°å›¾è¡¨
            updateCharts();
        }

        // è®¡ç®—å¡è·¯é‡Œ
        function calculateCalories(food, amount, category) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨è¾“å…¥çš„å¡è·¯é‡Œå€¼
            const manualCalories = document.getElementById('calories').value;
            if (manualCalories && !isNaN(manualCalories) && manualCalories > 0) {
                return parseFloat(manualCalories);
            }

            // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨è¾“å…¥ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘è®¡ç®—
            const standardAmount = standardizeAmount(amount);
            const categoryName = category.split('(')[0].trim();
            const caloriesPer100g = CONFIG.CALORIES_DATABASE[categoryName]?.[food] || 100;
            return (caloriesPer100g * standardAmount) / 100;
        }

        // ä¸­æ–‡æ•°å­—è½¬æ¢
        function chineseToNumber(chinese) {
            const numbers = {
                'é›¶': 0, 'ä¸€': 1, 'äºŒ': 2, 'ä¸¤': 2, 'ä¸‰': 3, 'å››': 4,
                'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åŠ': 0.5
            };
            return numbers[chinese] || chinese;
        }

        // æ ‡å‡†åŒ–ä»½é‡
        function standardizeAmount(amount) {
            // å¤„ç†ä¸­æ–‡æ•°å­—
            amount = amount.replace(/[ä¸€äºŒä¸¤ä¸‰å››äº”å…­ä¸ƒå…«ä¹ååŠ]/g, match => chineseToNumber(match));
            
            // å¤„ç†æ¨¡ç³Šæè¿°
            if (['é€‚é‡', 'å°‘è®¸'].includes(amount)) {
                return 50; // æŒ‰50gè®¡ç®—
            }

            // æå–æ•°å­—å’Œå•ä½
            const match = amount.match(/(\d+\.?\d*)(ç¢—|ä»½|ç‰‡|ä¸ª|ç›’|æ¯|g|å…‹)?/);
            if (!match) return 100; // é»˜è®¤100g

            const [, num, unit] = match;
            const number = parseFloat(num);

            if (!unit || unit === 'g' || unit === 'å…‹') return number;

            // æ ¹æ®å•ä½è½¬æ¢ä¸ºå…‹æ•°
            return number * (CONFIG.STANDARD_PORTIONS[unit] || 100);
        }

        // ä¿®æ”¹åˆå§‹åŒ–å›¾è¡¨å‡½æ•°
        function initCharts() {
            try {
                const chartDom = document.getElementById('caloriesChart');
                if (!chartDom) {
                    console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨å…ƒç´ ');
                    return;
                }

                // é”€æ¯å·²å­˜åœ¨çš„å®ä¾‹
                const existingChart = echarts.getInstanceByDom(chartDom);
                if (existingChart) {
                    existingChart.dispose();
                }

                // åˆ›å»ºæ–°å®ä¾‹
                const caloriesChart = echarts.init(chartDom);
                const option = {
                    title: { 
                        text: 'å¡è·¯é‡Œæ‘„å…¥è¶‹åŠ¿',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: { 
                        type: 'category',
                        data: [],
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: { 
                        type: 'value',
                        name: 'å¡è·¯é‡Œ'
                    },
                    series: [{
                        name: 'æ¯æ—¥å¡è·¯é‡Œ',
                        type: 'line',
                        data: [],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#4CAF50'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(76,175,80,0.3)' },
                                { offset: 1, color: 'rgba(76,175,80,0.1)' }
                            ])
                        }
                    }]
                };
                
                caloriesChart.setOption(option);
                window.addEventListener('resize', () => caloriesChart.resize());
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹æ›´æ–°å›¾è¡¨å‡½æ•°
        function updateCharts() {
            try {
                const chartDom = document.getElementById('caloriesChart');
                const chart = echarts.getInstanceByDom(chartDom);
                
                if (!chart) {
                    console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®ä¾‹');
                    initCharts();
                    return;
                }

                // æ•°æ®é¢„å¤„ç†
                const records = foodRecords.records || [];
                console.log('å›¾è¡¨æ›´æ–°æ•°æ®:', records); // è°ƒè¯•æ—¥å¿—

                if (records.length === 0) {
                    chart.setOption({
                        xAxis: { data: [] },
                        series: [{ data: [] }]
                    });
                    return;
                }

                // æŒ‰æ—¥æœŸæ’åº
                const sortedRecords = [...records].sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );

                // è®¡ç®—æ¯æ—¥æ€»å¡è·¯é‡Œ
                const chartData = sortedRecords.map(record => {
                    const dailyCalories = record.meals.reduce((total, meal) => 
                        total + meal.foods.reduce((mealTotal, food) => 
                            mealTotal + (parseFloat(food.calories) || 0), 0), 0);
                    
                    return {
                        date: record.date,
                        calories: Math.round(dailyCalories)
                    };
                });

                console.log('å¤„ç†åçš„å›¾è¡¨æ•°æ®:', chartData); // è°ƒè¯•æ—¥å¿—

                // æ›´æ–°å›¾è¡¨
                chart.setOption({
                    xAxis: {
                        data: chartData.map(item => item.date)
                    },
                    series: [{
                        data: chartData.map(item => item.calories)
                    }]
                });

                // æ›´æ–°çƒ­åŠ›å›¾
                updateHeatmap();
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', error);
                initCharts(); // å°è¯•é‡æ–°åˆå§‹åŒ–
            }
        }

        // æ›´æ–°çƒ­åŠ›å›¾
        function updateHeatmap() {
            const heatmapContainer = document.getElementById('mealHeatmap');
            
            // è·å–æœ€æ–°çš„è®°å½•
            const latestRecord = [...foodRecords.records]
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            // åˆå§‹åŒ–æ¯é¤æ•°æ®
            const mealData = {
                breakfast: { calories: 0, label: 'æ—©é¤', foods: [] },
                lunch: { calories: 0, label: 'åˆé¤', foods: [] },
                dinner: { calories: 0, label: 'æ™šé¤', foods: [] },
                snack: { calories: 0, label: 'åŠ é¤', foods: [] }
            };

            // å¦‚æœæœ‰è®°å½•ï¼Œè®¡ç®—æ¯é¤å¡è·¯é‡Œ
            if (latestRecord) {
                document.querySelector('.heatmap-title').textContent = 
                    `å¡è·¯é‡Œåˆ†å¸ƒ (${latestRecord.date})`;
                    
                latestRecord.meals.forEach(meal => {
                    meal.foods.forEach(food => {
                        mealData[meal.type].calories += food.calories;
                        mealData[meal.type].foods.push(`${food.name} (${food.amount})`);
                    });
                });
            } else {
                document.querySelector('.heatmap-title').textContent = 
                    'å¡è·¯é‡Œåˆ†å¸ƒ (æ— è®°å½•)';
            }

            const maxCalories = Math.max(...Object.values(mealData).map(m => m.calories));
            heatmapContainer.innerHTML = '';

            // ç§»é™¤æ—§çš„æç¤ºæ¡†
            const oldTooltip = document.querySelector('.meal-tooltip');
            if (oldTooltip) {
                oldTooltip.remove();
            }

            // åˆ›å»ºæ–°çš„æç¤ºæ¡†
            const tooltip = document.createElement('div');
            tooltip.className = 'meal-tooltip';
            heatmapContainer.appendChild(tooltip);  // å°†æç¤ºæ¡†æ·»åŠ åˆ°çƒ­åŠ›å›¾å®¹å™¨ä¸­

            // åˆ›å»ºçƒ­åŠ›å›¾
            Object.entries(mealData).forEach(([type, data]) => {
                const percentage = maxCalories ? (data.calories / maxCalories) * 100 : 0;
                
                const mealRow = document.createElement('div');
                mealRow.className = 'meal-heatmap';
                
                const heatBar = document.createElement('div');
                heatBar.className = 'heat-bar';
                
                const heatFill = document.createElement('div');
                heatFill.className = 'heat-fill';
                heatFill.style.width = `${percentage}%`;
                
                // æ·»åŠ é¼ æ ‡äº‹ä»¶
                if (data.foods.length > 0) {
                    heatFill.addEventListener('mouseenter', (e) => {
                        const rect = e.target.getBoundingClientRect();
                        tooltip.innerHTML = `
                            <div class="meal-tooltip-title">${data.label}é£Ÿç‰©æ˜ç»†</div>
                            <ul class="meal-tooltip-list">
                                ${data.foods.map(food => `<li>${food}</li>`).join('')}
                            </ul>
                        `;

                        // ç®€åŒ–å®šä½é€»è¾‘
                        let left = rect.right + 10;  // åœ¨çƒ­åŠ›æ¡å³ä¾§æ˜¾ç¤º
                        let top = rect.top;

                        // æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºå³è¾¹ç•Œ
                        const tooltipRect = tooltip.getBoundingClientRect();
                        if (left + tooltipRect.width > window.innerWidth) {
                            left = rect.left - tooltipRect.width - 10;  // æ”¹ä¸ºå·¦ä¾§æ˜¾ç¤º
                        }

                        tooltip.style.left = `${left}px`;
                        tooltip.style.top = `${top}px`;
                        tooltip.classList.add('visible');
                    });

                    heatFill.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('visible');
                    });
                }
                
                const calorieValue = document.createElement('span');
                calorieValue.className = 'calories-value';
                calorieValue.textContent = `${Math.round(data.calories)} å¡`;
                
                heatBar.appendChild(heatFill);
                heatBar.appendChild(calorieValue);
                
                mealRow.innerHTML = `<div class="meal-label">${data.label}</div>`;
                mealRow.appendChild(heatBar);
                
                heatmapContainer.appendChild(mealRow);
            });
        }

        // ä¿®æ”¹ formatRecordsForAI å‡½æ•°
        function formatRecordsForAI(records) {
            const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é¥®é£Ÿåˆ†æå¸ˆï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä½æ“…é•¿è®²æ•…äº‹çš„ç¾é£Ÿè¾¾äººã€‚è¯·è¿ç”¨ä½ çš„ä¸“ä¸šçŸ¥è¯†å’Œæ•…äº‹è®²è¿°èƒ½åŠ›ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä»½ç”ŸåŠ¨æœ‰è¶£çš„é¥®é£Ÿåˆ†ææŠ¥å‘Šã€‚

åˆ†æç»´åº¦ï¼š
1. è¥å…»å‡è¡¡åˆ†æ
   - è®¡ç®—æ¯æ—¥æ€»å¡è·¯é‡Œå¹¶ä¸æ¨èå€¼æ¯”è¾ƒ
   - åˆ†æå„ç±»é£Ÿç‰©æ¯”ä¾‹çš„åˆç†æ€§
   - è¯„ä¼°è¥å…»å‡è¡¡ç¨‹åº¦
   - è¯†åˆ«è¥å…»è¿‡å‰©æˆ–ä¸è¶³

2. æ—¶é—´ä¹ æƒ¯åˆ†æ
   - å‘ç°ç”¨æˆ·æœ€å–œæ¬¢çš„ç”¨é¤æ—¶é—´æ®µ
   - æ‰¾å‡ºç‹¬ç‰¹çš„è¿›é£Ÿæ—¶é—´æ¨¡å¼
   - åˆ†æé¤æ¬¡é—´éš”è§„å¾‹
   - è¯„ä¼°æ˜¯å¦å­˜åœ¨æ·±å¤œè¿›é£Ÿï¼ˆ22:00åï¼‰

3. ç¾é£Ÿåå¥½æ´å¯Ÿ
   - å‘ç°æœ€å¸¸æ­é…çš„é£Ÿç‰©ç»„åˆ
   - è¯†åˆ«å‡ºç”¨æˆ·çš„å£å‘³ç‰¹å¾
   - åˆ†æé£Ÿç‰©å¤šæ ·æ€§
   - åˆ›é€ ç‹¬ç‰¹çš„ç¾é£Ÿæ€§æ ¼æ ‡ç­¾

4. ç‰¹æ®Šæ¨¡å¼è¯†åˆ«
   - è¿ç»­å¤šå¤©ç›¸åŒé£Ÿç‰©åˆ†æ
   - ä¸è§„å¾‹é¤æ¬¡è¯†åˆ«
   - ç‰¹æ®Šæ­é…ç»„åˆè¯„ä¼°
   - å‘ç°ç‹¬ç‰¹çš„é¥®é£Ÿä¹ æƒ¯

è¯·ä»¥ä¸‹é¢çš„HTMLæ ¼å¼è¿”å›åˆ†æç»“æœï¼š

<analysis>
    <section class="data-summary">
        <h3>ğŸ“Š è¥å…»æ•°æ®æ¦‚è¦</h3>
        <div class="data-item">
            <span class="stat-number">{æ¯æ—¥å¹³å‡å¡è·¯é‡Œ}</span>
            <span class="stat-label">åƒå¡</span>
        </div>
        <div class="data-item">
            <h4>ğŸ¥— é£Ÿç‰©åˆ†ç±»å æ¯”</h4>
            <div class="stat-chart">å„ç±»é£Ÿç‰©æ¯”ä¾‹</div>
        </div>
        <div class="data-item">
            <h4>âš–ï¸ è¥å…»å‡è¡¡è¯„åˆ†</h4>
            <div class="stat-chart">è¥å…»å‡è¡¡åˆ†æ</div>
        </div>
    </section>
    
    <section class="food-personality">
        <h3>ğŸ­ ä½ çš„ç¾é£Ÿæ€§æ ¼</h3>
        <div class="tags">
            <!-- æ¯ä¸ªæ ‡ç­¾éƒ½åº”è¯¥æœ‰emojiã€åç§°å’Œè§£é‡Š -->
            <div class="tag-group">
                <div class="tag">{emoji} {æ€§æ ¼æ ‡ç­¾}</div>
                <div class="tag-explanation">å¦™è¶£æ¨ªç”Ÿçš„è§£é‡Š</div>
            </div>
        </div>
    </section>
    
    <section class="unique-findings">
        <h3>ğŸ” ç‹¬ç‰¹å‘ç°</h3>
        <div class="findings-item">
            <h4>â° æ—¶é—´ä¹ æƒ¯åˆ†æ</h4>
            <p>ç”¨æˆ·çš„ç”¨é¤æ—¶é—´ç‰¹ç‚¹</p>
        </div>
        <div class="findings-item">
            <h4>ğŸ³ æ­é…ç‰¹è‰²</h4>
            <p>ç‹¬ç‰¹çš„é£Ÿç‰©æ­é…ä¹ æƒ¯</p>
        </div>
        <div class="findings-item">
            <h4>ğŸŒŸ ç‰¹åˆ«ä¹‹å¤„</h4>
            <p>å…¶ä»–æœ‰è¶£å‘ç°</p>
        </div>
    </section>
    
    <section class="food-story">
        <h3>ğŸ“– ä½ çš„ç¾é£Ÿæ•…äº‹</h3>
        <p>åŸºäºæ•°æ®ç¼–ç»‡çš„è¶£å‘³æ•…äº‹ï¼Œèå…¥ä¸»è¦å‘ç°ï¼Œçªå‡ºä¸ªæ€§ç‰¹ç‚¹</p>
    </section>
    
    <section class="suggestions">
        <h3>ğŸ’¡ æš–å¿ƒå°å»ºè®®</h3>
        <div class="suggestion-item">
            <span class="suggestion-icon">ğŸ¯</span>
            <div class="suggestion-content">
                <h4>å¹³è¡¡ä¹‹é“</h4>
                <p>åŸºäºè¥å…»åˆ†æçš„å»ºè®®</p>
            </div>
        </div>
        <div class="suggestion-item">
            <span class="suggestion-icon">ğŸŒˆ</span>
            <div class="suggestion-content">
                <h4>ç”Ÿæ´»ä¹‹è¶£</h4>
                <p>åŸºäºä¹ æƒ¯åˆ†æçš„å»ºè®®</p>
            </div>
        </div>
    </section>
</analysis>

è¦æ±‚ï¼š
1. ä½¿ç”¨å¯Œæœ‰åˆ›æ„çš„æ¯”å–»å’Œç”ŸåŠ¨çš„æè¿°
2. æ¯ä¸ªåˆ†æç‚¹éƒ½è¦åŸºäºå…·ä½“æ•°æ®
3. ä¿æŒæ¸©æš–å‹å¥½çš„è¯­æ°”ï¼Œåƒè€æœ‹å‹èŠå¤©
4. é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢æ·»è¶£å‘³
5. åœ¨ä¿æŒä¸“ä¸šæ€§çš„åŒæ—¶æ³¨å…¥å¹½é»˜æ„Ÿ
6. å»ºè®®è¦å…·ä½“å¯è¡Œï¼Œé¿å…ç©ºæ³›è¯´æ•™

ç°åœ¨ï¼Œè¯·åˆ†æä»¥ä¸‹7å¤©çš„é¥®é£Ÿè®°å½•ï¼š`;

            // æ ¼å¼åŒ–è®°å½•æ•°æ®
            let recordsText = records.map(record => {
                const meals = record.meals.map(meal => {
                    const foods = meal.foods.map(food => 
                        `${food.name} (${food.amount}, ${food.category})`
                    ).join('ã€');
                    return `${meal.time} ${meal.type}: ${foods}`;
                }).join('\n');
                return `${record.date}:\n${meals}`;
            }).join('\n\n');

            // æ·»åŠ åˆ†æè¦æ±‚
            const analysisRequest = `

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼æä¾›åˆ†æï¼š

1. ã€æ•°æ®æ¦‚è¦ã€‘
   - æ¯æ—¥å¹³å‡å¡è·¯é‡Œ
   - é£Ÿç‰©åˆ†ç±»å æ¯”
   - ä¸»è¦è¥å…»æŒ‡æ ‡
   - å…³é”®æ•°æ®ç‰¹å¾

2. ã€ä½ çš„ç¾é£Ÿæ€§æ ¼ã€‘
   - 3-4ä¸ªä¸ªæ€§åŒ–æ ‡ç­¾
   - æ¯ä¸ªæ ‡ç­¾é…æœ‰ç®€çŸ­æœ‰è¶£çš„è§£é‡Š
   - åŸºäºå®é™…æ•°æ®çš„æ€§æ ¼ç‰¹å¾

3. ã€ç‹¬ç‰¹å‘ç°ã€‘
   - 2-3ä¸ªæœ‰è¶£çš„æ•°æ®å‘ç°
   - ç”ŸåŠ¨çš„æ¯”å–»è¯´æ˜
   - çªå‡ºç‰¹åˆ«ä¹‹å¤„

4. ã€ç¾é£Ÿæ•…äº‹ã€‘
   - 200å­—ä»¥å†…çš„è¶£å‘³æ•…äº‹
   - èå…¥ä¸»è¦æ•°æ®å‘ç°
   - ä½¿ç”¨ç”ŸåŠ¨æœ‰è¶£çš„è¡¨è¾¾

5. ã€æš–å¿ƒå°å»ºè®®ã€‘
   - 1-2æ¡ä¸ªæ€§åŒ–å»ºè®®
   - åŸºäºæ•°æ®çš„å…·ä½“æ”¹è¿›ç‚¹
   - ä¿æŒé¼“åŠ±æ€§è´¨

è¯·æ³¨æ„ï¼š
- ä½¿ç”¨å‹å¥½äº²åˆ‡çš„è¯­æ°”
- ä¿æŒè¶£å‘³æ€§
- é¿å…è¯´æ•™
- é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·
- å¯ä»¥é€‚åº¦è°ƒä¾ƒ
`;

            return prompt + recordsText + analysisRequest;
        }

        // è°ƒç”¨ Deepseek API
        async function callDeepseekAPI(content) {
            const options = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.API.DEEPSEEK_API_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: "deepseek-chat",  // ä¿®æ”¹ä¸ºæ­£ç¡®çš„æ¨¡å‹åç§°
                    messages: [{
                        role: "user",
                        content: content
                    }],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            };

            try {
                // é¦–å…ˆå°è¯•ä¸»è¦ API
                let response = await fetch(CONFIG.API.DEEPSEEK_API_URL, options);
                
                // å¦‚æœä¸»è¦ API å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ API
                if (!response.ok && CONFIG.API.FALLBACK_API_URL) {
                    console.log('ä¸»è¦ API è°ƒç”¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ API');
                    response = await fetch(CONFIG.API.FALLBACK_API_URL, options);
                }

                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                return data.choices[0].message.content;
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥');
                }
                throw new Error(`AI åˆ†æå¤±è´¥: ${error.message}`);
            }
        }

        // ä¿®æ”¹ generateAIAnalysis å‡½æ•°çš„æ•°æ®éªŒè¯
        async function generateAIAnalysis() {
            const analysisDiv = document.getElementById('aiAnalysis');
            analysisDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è®°å½•
                if (!foodRecords.records || !Array.isArray(foodRecords.records) || foodRecords.records.length === 0) {
                    analysisDiv.innerHTML = '<p>æ²¡æœ‰è¶³å¤Ÿçš„é¥®é£Ÿè®°å½•æ¥ç”Ÿæˆåˆ†ææŠ¥å‘Šã€‚è¯·è‡³å°‘è®°å½•ä¸€å¤©çš„é¥®é£Ÿã€‚</p>';
                    return;
                }

                // éªŒè¯è®°å½•æ˜¯å¦æœ‰æ•ˆ
                const validRecords = foodRecords.records.filter(record => 
                    record && record.meals && Array.isArray(record.meals) && 
                    record.meals.some(meal => meal.foods && meal.foods.length > 0)
                );

                if (validRecords.length === 0) {
                    analysisDiv.innerHTML = '<p>ç°æœ‰è®°å½•æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•ç”Ÿæˆåˆ†ææŠ¥å‘Šã€‚è¯·ç¡®ä¿è®°å½•åŒ…å«å®Œæ•´çš„é¤é£Ÿä¿¡æ¯ã€‚</p>';
                    return;
                }

                // ç»§ç»­ç”ŸæˆæŠ¥å‘Š
                const records = getLastSevenDaysRecords();
                const content = formatRecordsForAI(records);
                
                try {
                    const analysis = await callDeepseekAPI(content);
                    analysisDiv.innerHTML = `
                        <div class="analysis-report">
                            ${analysis}
                            <div class="report-date">
                                ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}
                            </div>
                        </div>
                    `;
                } catch (apiError) {
                    // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    analysisDiv.innerHTML = `
                        <div class="error-message">
                            <h3>ğŸ˜” æŠ±æ­‰ï¼Œç”ŸæˆæŠ¥å‘Šæ—¶é‡åˆ°äº†é—®é¢˜</h3>
                            <p>${apiError.message}</p>
                            <p>å»ºè®®ï¼š</p>
                            <ul>
                                <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                                <li>ç¨åå†è¯•</li>
                                <li>å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                analysisDiv.innerHTML = `
                    <div class="error-message">
                        <p>ç”Ÿæˆåˆ†ææŠ¥å‘Šæ—¶å‡ºé”™ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        // è·å–æœ€åä¸ƒå¤©çš„è®°å½•ï¼ˆæˆ–å…¨éƒ¨è®°å½•å¦‚æœä¸è¶³ä¸ƒå¤©ï¼‰
        function getLastSevenDaysRecords() {
            // å¯¹è®°å½•æŒ‰æ—¥æœŸæ’åº
            const sortedRecords = [...foodRecords.records].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            // å–æœ€è¿‘çš„7æ¡è®°å½•æˆ–å…¨éƒ¨è®°å½•ï¼ˆå¦‚æœå°‘äº7æ¡ï¼‰
            return sortedRecords.slice(0, 7);
        }

        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            try {
                const data = JSON.stringify(foodRecords, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `foodRecords_${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥');
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllRecords() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                try {
                    // æ¸…ç©ºæ•°æ®å¯¹è±¡
                    foodRecords = { records: [] };
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('foodRecords');
                    // æ›´æ–°å›¾è¡¨
                    updateCharts();
                    alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼');
                } catch (error) {
                    console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
                    alert('æ¸…é™¤æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        // æ ¹æ®æ—¶é—´è‡ªåŠ¨é€‰æ‹©ç”¨é¤ç±»å‹
        function updateMealType() {
            const timeInput = document.getElementById('time').value;
            const [hours] = timeInput.split(':').map(Number);
            const mealType = document.getElementById('mealType');
            
            // æ ¹æ®æ—¶é—´æ®µé€‰æ‹©ç”¨é¤ç±»å‹
            if (hours >= 5 && hours < 10) {
                mealType.value = 'breakfast';  // 5:00-9:59 æ—©é¤
            } else if (hours >= 10 && hours < 15) {
                mealType.value = 'lunch';      // 10:00-14:59 åˆé¤
            } else if (hours >= 15 && hours < 21) {
                mealType.value = 'dinner';     // 15:00-20:59 æ™šé¤
            } else {
                mealType.value = 'snack';      // å…¶ä»–æ—¶é—´ä¸ºåŠ é¤
            }
        }

        // ä¿®æ”¹åˆå§‹åŒ–å’Œæ•°æ®åŠ è½½å‡½æ•°
        async function initializeFoodRecords() {
            try {
                const savedData = localStorage.getItem('foodRecords');
                if (savedData) {
                    foodRecords = JSON.parse(savedData);
                    console.log('å·²åŠ è½½æœ¬åœ°æ•°æ®:', foodRecords);
                }
                return true;
            } catch (error) {
                console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error);
                foodRecords = { records: [] };
                return false;
            }
        }

        // ä¿®æ”¹åˆå§‹åŒ–å›¾è¡¨å‡½æ•°
        function initCharts() {
            try {
                const chartDom = document.getElementById('caloriesChart');
                if (!chartDom) {
                    console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨å…ƒç´ ');
                    return;
                }

                // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                chartDom.style.width = '100%';
                chartDom.style.height = '350px';

                // é”€æ¯å·²å­˜åœ¨çš„å®ä¾‹
                const existingChart = echarts.getInstanceByDom(chartDom);
                if (existingChart) {
                    existingChart.dispose();
                }

                // åˆ›å»ºæ–°å®ä¾‹
                const caloriesChart = echarts.init(chartDom);
                
                // åŸºç¡€é…ç½®
                const option = {
                    title: { 
                        text: 'å¡è·¯é‡Œæ‘„å…¥è¶‹åŠ¿',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: '{b}: {c} å¡è·¯é‡Œ'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: { 
                        type: 'category',
                        data: [],
                        axisLabel: {
                            rotate: 45,
                            interval: 0
                        }
                    },
                    yAxis: { 
                        type: 'value',
                        name: 'å¡è·¯é‡Œ'
                    },
                    series: [{
                        name: 'æ¯æ—¥å¡è·¯é‡Œ',
                        type: 'line',
                        data: [],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#4CAF50'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(76,175,80,0.3)' },
                                { offset: 1, color: 'rgba(76,175,80,0.1)' }
                            ])
                        }
                    }]
                };
                
                caloriesChart.setOption(option);

                // æ·»åŠ å“åº”å¼æ”¯æŒ
                window.addEventListener('resize', () => {
                    caloriesChart.resize();
                });

                return caloriesChart;
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
                return null;
            }
        }

        // ä¿®æ”¹æ›´æ–°å›¾è¡¨å‡½æ•°
        function updateCharts() {
            try {
                const chartDom = document.getElementById('caloriesChart');
                let chart = echarts.getInstanceByDom(chartDom);
                
                if (!chart) {
                    chart = initCharts();
                    if (!chart) return;
                }

                // ç¡®ä¿æœ‰æ•°æ®
                if (!foodRecords || !foodRecords.records) {
                    console.log('æ²¡æœ‰å¯ç”¨æ•°æ®ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨');
                    chart.setOption({
                        xAxis: { data: [] },
                        series: [{ data: [] }]
                    });
                    return;
                }

                // æŒ‰æ—¥æœŸæ’åºå¹¶è®¡ç®—æ¯æ—¥æ€»å¡è·¯é‡Œ
                const dailyData = foodRecords.records
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => {
                        const dailyCalories = record.meals.reduce((total, meal) => 
                            total + meal.foods.reduce((mealTotal, food) => 
                                mealTotal + (parseFloat(food.calories) || 0), 0), 0);
                        
                        return {
                            date: record.date,
                            calories: Math.round(dailyCalories)
                        };
                    });

                console.log('å¤„ç†åçš„å›¾è¡¨æ•°æ®:', dailyData);

                // æ›´æ–°å›¾è¡¨æ•°æ®
                chart.setOption({
                    xAxis: {
                        data: dailyData.map(item => item.date)
                    },
                    series: [{
                        data: dailyData.map(item => item.calories)
                    }]
                });

                // æ›´æ–°çƒ­åŠ›å›¾
                updateHeatmap();
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹æ•°æ®å¯¼å…¥å‡½æ•°
        function importRecords(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    console.log('å¯¼å…¥çš„åŸå§‹æ•°æ®:', importedData);

                    // éªŒè¯æ•°æ®ç»“æ„
                    if (!importedData || !importedData.records) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼: ç¼ºå°‘recordså­—æ®µ');
                    }

                    // åˆå¹¶æˆ–æ›¿æ¢æ•°æ®
                    if (confirm('æ˜¯å¦åˆå¹¶æ•°æ®ï¼Ÿç‚¹å‡»"ç¡®å®š"åˆå¹¶ï¼Œç‚¹å‡»"å–æ¶ˆ"æ›¿æ¢')) {
                        const existingDates = new Set(foodRecords.records.map(r => r.date));
                        foodRecords.records = [
                            ...foodRecords.records,
                            ...importedData.records.filter(r => !existingDates.has(r.date))
                        ];
                    } else {
                        foodRecords = importedData;
                    }

                    // ä¿å­˜å¹¶æ›´æ–°
                    localStorage.setItem('foodRecords', JSON.stringify(foodRecords));
                    console.log('ä¿å­˜çš„æ•°æ®:', foodRecords);
                    
                    // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–å’Œæ›´æ–°å›¾è¡¨
                    initCharts();
                    updateCharts();
                    
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                }
            };

            reader.onerror = () => alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            reader.readAsText(file);
            event.target.value = '';
        }

        // ä¿®æ”¹é¡µé¢åŠ è½½å¤„ç†
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeFoodRecords();
            initCharts();
            updateCharts();
            
            // è®¾ç½®å½“å‰æ—¥æœŸå’Œæ—¶é—´
            const now = new Date();
            document.getElementById('date').valueAsDate = now;
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('time').value = `${hours}:${minutes}`;
            
            updateMealType();
        });

        // ä¿®æ”¹ç”Ÿæˆåˆ†ææŠ¥å‘Šå‡½æ•°
        async function generateAIAnalysis() {
            const analysisDiv = document.getElementById('aiAnalysis');
            analysisDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';

            try {
                // æ•°æ®éªŒè¯
                if (!foodRecords.records || foodRecords.records.length === 0) {
                    throw new Error('æ²¡æœ‰è¶³å¤Ÿçš„é¥®é£Ÿè®°å½•æ¥ç”Ÿæˆåˆ†ææŠ¥å‘Šã€‚è¯·è‡³å°‘è®°å½•ä¸€å¤©çš„é¥®é£Ÿã€‚');
                }

                // è®¡ç®—åˆ†ææ•°æ®
                const records = foodRecords.records;
                const analysis = generateLocalAnalysis(records);
                
                // æ˜¾ç¤ºæŠ¥å‘Š
                analysisDiv.innerHTML = `
                    <div class="analysis-report">
                        ${analysis}
                        <div class="report-date">
                            ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
            } catch (error) {
                analysisDiv.innerHTML = `
                    <div class="error-message">
                        <h3>ğŸ˜” ${error.message}</h3>
                    </div>
                `;
            }
        }

        // æ·»åŠ æœ¬åœ°åˆ†æç”Ÿæˆå‡½æ•°
        function generateLocalAnalysis(records) {
            // 1. è®¡ç®—åŸºç¡€æ•°æ®
            const totalCalories = records.reduce((sum, record) => {
                return sum + record.meals.reduce((mealSum, meal) => {
                    return mealSum + meal.foods.reduce((foodSum, food) => {
                        return foodSum + (parseFloat(food.calories) || 0);
                    }, 0);
                }, 0);
            }, 0);

            const avgCalories = Math.round(totalCalories / records.length);

            // 2. è®¡ç®—é£Ÿç‰©åˆ†ç±»ç»Ÿè®¡
            const categoryStats = {};
            records.forEach(record => {
                record.meals.forEach(meal => {
                    meal.foods.forEach(food => {
                        categoryStats[food.category] = (categoryStats[food.category] || 0) + 1;
                    });
                });
            });

            // 3. åˆ†æç”¨é¤æ—¶é—´æ¨¡å¼
            const mealTimes = {
                breakfast: [],
                lunch: [],
                dinner: [],
                snack: []
            };

            records.forEach(record => {
                record.meals.forEach(meal => {
                    if (meal.time) {
                        mealTimes[meal.type].push(meal.time);
                    }
                });
            });

            // 4. ç”ŸæˆHTMLæŠ¥å‘Š
            return `
                <section class="data-summary">
                    <h3>ğŸ“Š è¥å…»æ•°æ®æ¦‚è¦</h3>
                    <div class="data-item">
                        <span class="stat-number">${avgCalories}</span>
                        <span class="stat-label">å¹³å‡æ¯æ—¥å¡è·¯é‡Œ</span>
                    </div>
                    <div class="data-item">
                        <h4>ğŸ¥— å¸¸è§é£Ÿç‰©ç±»åˆ«</h4>
                        <div class="stat-chart">
                            ${Object.entries(categoryStats)
                                .sort(([,a], [,b]) => b - a)
                                .map(([category, count]) => 
                                    `<div class="tag">${category}: ${count}æ¬¡</div>`
                                ).join('')}
                        </div>
                    </div>
                </section>
                
                <section class="food-personality">
                    <h3>ğŸ­ é¥®é£Ÿç‰¹ç‚¹åˆ†æ</h3>
                    <div class="tags">
                        <div class="tag-group">
                            <div class="tag">â° è§„å¾‹ç”¨é¤æŒ‡æ•°</div>
                            <div class="tag-explanation">
                                å…±è®°å½• ${records.length} å¤©çš„é¥®é£Ÿæ•°æ®
                            </div>
                        </div>
                        <div class="tag-group">
                            <div class="tag">ğŸœ é¥®é£Ÿå¤šæ ·æ€§</div>
                            <div class="tag-explanation">
                                æ¶‰åŠ ${Object.keys(categoryStats).length} ç§é£Ÿç‰©ç±»åˆ«
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="suggestions">
                    <h3>ğŸ’¡ å»ºè®®</h3>
                    <div class="suggestion-item">
                        <span class="suggestion-icon">ğŸ¯</span>
                        <div class="suggestion-content">
                            <h4>è¥å…»å‡è¡¡å»ºè®®</h4>
                            <p>${generateNutritionAdvice(avgCalories, categoryStats)}</p>
                        </div>
                    </div>
                    <div class="suggestion-item">
                        <span class="suggestion-icon">â°</span>
                        <div class="suggestion-content">
                            <h4>ç”¨é¤æ—¶é—´å»ºè®®</h4>
                            <p>${generateTimeAdvice(mealTimes)}</p>
                        </div>
                    </div>
                </section>
            `;
        }

        // ç”Ÿæˆè¥å…»å»ºè®®
        function generateNutritionAdvice(avgCalories, categoryStats) {
            let advice = '';
            
            if (avgCalories < 1500) {
                advice += 'æ‚¨çš„æ—¥å‡å¡è·¯é‡Œæ‘„å…¥åä½ï¼Œå»ºè®®é€‚å½“å¢åŠ é£Ÿé‡ï¼Œç‰¹åˆ«æ˜¯ä¼˜è´¨è›‹ç™½è´¨å’Œå…¨è°·ç‰©ã€‚';
            } else if (avgCalories > 2500) {
                advice += 'æ‚¨çš„æ—¥å‡å¡è·¯é‡Œæ‘„å…¥åé«˜ï¼Œå»ºè®®æ§åˆ¶æ¯é¤ä»½é‡ï¼Œå¢åŠ è¿åŠ¨é‡ã€‚';
            } else {
                advice += 'æ‚¨çš„æ—¥å‡å¡è·¯é‡Œæ‘„å…¥é€‚ä¸­ï¼Œç»§ç»­ä¿æŒå¥åº·çš„é¥®é£Ÿä¹ æƒ¯ã€‚';
            }

            // åˆ†æé£Ÿç‰©å¤šæ ·æ€§
            const categories = Object.keys(categoryStats);
            if (categories.length < 5) {
                advice += 'å»ºè®®å¢åŠ é¥®é£Ÿç§ç±»ï¼Œå°è¯•æ›´å¤šä¸åŒç±»å‹çš„é£Ÿç‰©ã€‚';
            }

            return advice;
        }

        // ç”Ÿæˆç”¨é¤æ—¶é—´å»ºè®®
        function generateTimeAdvice(mealTimes) {
            let advice = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è§„å¾‹çš„æ—©é¤
            if (mealTimes.breakfast.length < foodRecords.records.length * 0.7) {
                advice += 'å»ºè®®å…»æˆè§„å¾‹åƒæ—©é¤çš„ä¹ æƒ¯ï¼Œè¿™å¯¹èº«ä½“å¥åº·å¾ˆé‡è¦ã€‚';
            }

            // æ£€æŸ¥å¤œå®µæƒ…å†µ
            const lateNightSnacks = mealTimes.snack.filter(time => {
                const hour = parseInt(time.split(':')[0]);
                return hour >= 22 || hour < 5;
            });

            if (lateNightSnacks.length > 0) {
                advice += 'æ³¨æ„åˆ°æ‚¨æœ‰æ·±å¤œè¿›é£Ÿçš„æƒ…å†µï¼Œå»ºè®®é¿å…åœ¨æ™šä¸Š10ç‚¹åè¿›é£Ÿã€‚';
            }

            if (!advice) {
                advice = 'æ‚¨çš„ç”¨é¤æ—¶é—´å®‰æ’æ¯”è¾ƒåˆç†ï¼Œç»§ç»­ä¿æŒï¼';
            }

            return advice;
        }
    </script>
</body>
</html>
